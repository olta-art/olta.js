<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Example p5 Project</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>

  <script src="../../lib/p5.min.js"></script>
  <script src="../../lib/olta.js"></script>
  <script>
    let olta
    let boxes

    const scale = 20

    function setup() {
      createCanvas(displayWidth, displayHeight)
      background(0)
      noStroke()

      olta = Olta()
      olta.onUpdate(() => {
        const latestBoxes = olta.getAll("boxes")

        // only update the boxes if there are new boxes
        if(!latestBoxes || latestBoxes.length < 1) {
          return
        }

        // update the boxes with latest data from olta, making sure to parse the values
        boxes = parseBoxes(latestBoxes)

        // trigger p5 draw function
        loop()
      })
    }

    function draw() {
      background(0)

      if (!boxes || boxes.length < 1) {
        return
      }

      boxes.forEach((box, index) => {
        // convert box.x and box.y from a percentage to coordinates
        const x = percentageOf(windowWidth, box.x)
        const y = percentageOf(windowHeight, box.y)

        // render boxes
        fill(box.color)
        rect(x, y, box.size, box.size)
      })

      // only run draw function once
      noLoop()
    }

    function mouseClicked() {
      // create a random new box based on mouse position, making sure to format all the values
      const box = formatBox({
        color: Math.random() * 255,
        size: 1 + (Math.random() * 2),
        x: mouseX / windowWidth * 100,
        y: mouseY / windowHeight * 100
      })

      // create a new box at the location of the mouse
      olta.create("boxes", box)
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight)
      // trigger p5 draw function on resize
      loop()
    }

    // utils
    function percentageOf(value, percent) {
      return value * (percent * 0.01)
    }

    // parse the boxes from olta.update so we can use them in p5
    // for example the x value will change from x: "50n" to x: 50
    function parseBoxes(boxes) {
      if(!boxes || boxes.length < 1){
        return []
      }

      return boxes.map(box => {
        box.size = parseBigInt(box.size) * scale
        box.color = parseBigInt(box.color)
        box.x = parseBigInt(box.x)
        box.y = parseBigInt(box.y)

        return box
      })
    }

    // format the box so we can send it to olta
    // for example the x value will change from x:50 to x:"50n"
    function formatBox(box) {
      return {
        color: formatBigInt(box.color),
        size: formatBigInt(box.size),
        x: formatBigInt(box.x),
        y: formatBigInt(box.y)
      }
    }

    function formatBigInt(value) {
      return Math.floor(value) + "n"
    }

    function parseBigInt(value) {
      return Number(value.slice(0, -1))
    }
  </script>
</body>

</html>