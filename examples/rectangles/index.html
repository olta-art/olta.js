<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Example p5 Project</title>
  </head>

  <body>
    <!-- Loading Elements -->
    <div id="loadingOverlay">
      <div id="loadingDiv">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="#FFFFFF50" stroke-width="10" />
          <circle id="progress" cx="50" cy="50" r="45" fill="none" stroke="black" stroke-width="11" stroke-dasharray="0 283" stroke-linecap="round" />
        </svg>
      </div>
      <div id="popupMessage">
        <span id="loadingText"></span>
      </div>
    </div>
    <!-- Loading Elements -->

    <!-- Importing p5 and Olta libraries -->
    <script src="../../lib/p5.min.js"></script>
    <script src="../../lib/olta.js"></script>

    <script>
      // First we need to initialize Olta in a variable like this
      const olta = Olta();

      // ----------- Loading Logic ----------- 
      const timerSeconds = 1000; // Time between creating new interactions, in milliseconds (1000 = 10 seconds)
      const loadingOverlay = document.getElementById("loadingOverlay");
      const loadingText = document.getElementById("loadingText");
      const progress = document.getElementById('progress');
      let walletAddress;
      let message = "Thanks for collaborating with the artwork!";
      loadingText.innerText = message;
      let loading = false;
      let timeLeft = timerSeconds;
      // --------------------------------------

      let boxes = []; // Array that will receive the collection documents (aka user transactions)
      let pendingBoxes = []; // Supporting array to display temporary objects before transactions come through

      const scale = 20;

      function setup() {
        createCanvas(displayWidth, displayHeight);
        background(0);
        noStroke();

        rectMode(CENTER);

        // This function runs all the time, retrieving transactions from Arweave via Warp
        olta.onUpdate(() => {
          boxes = olta.getAll("boxes"); // The boxes array gets the transactions
          walletAddress = olta.getActiveWalletAddress(); // This function retrieves the connected Othent Wallet to display while interacting

          // This adds the wallet address to the message, if Othent wallet was found during previous step
          if (walletAddress) {
            loadingText.innerText =
              walletAddress.slice(0, 4) + "..." + walletAddress.slice(-4) + " " + message;
          }

          // only update the boxes if there are new boxes
          if (!boxes || boxes.length < 1) {
            return;
          }

          // reset pending boxes
          pendingBoxes = [];

          // trigger p5 draw function
          loop();
        });
      }

      function draw() {
        background(0);
        noStroke();

        // ----------- Loading Logic -----------
        // Checking if the artwork is in a loading state
        if (loading) {
          // Displaying the loading elements
          loadingOverlay.style.display = "block";

          // Starting timer to prevent user from interacting and for duration of loading elements
          var timer = setInterval(() => {
            timeLeft -= 1;
            const dashOffset = ((timerSeconds - timeLeft) / timerSeconds) * 283;
            progress.style.strokeDasharray = `${dashOffset} 360`;
            // When the timer finished, reset status
            if (timeLeft <= 0) {
              loading = false;
              clearInterval(timer);
              loadingOverlay.style.display = "none";
              return;
            }
          }, 10);
        } else {
          // When there's no loading, reset the status
          timeLeft = timerSeconds;
          loadingOverlay.style.display = "none";
        }
        // ------------------------------------------------

        if (!boxes || boxes.length < 1) {
          return;
        }

        // draw boxes
        boxes?.forEach((box, index) => {
          // convert box.x and box.y from a percentage to coordinates
          const x = percentageOf(windowWidth, box.x);
          const y = percentageOf(windowHeight, box.y);

          // render box
          fill(box.color);
          rect(x, y, box.size * scale, box.size * scale);
        });

        // draw pending boxes
        noFill();
        pendingBoxes?.forEach((pendingBox, index) => {
          // convert pendingBox.x and pendingBox.y from a percentage to coordinates
          const x = percentageOf(windowWidth, pendingBox.x);
          const y = percentageOf(windowHeight, pendingBox.y);

          // render outline of pending box
          stroke(255, 0, 0);
          rect(x, y, pendingBox.size * scale, pendingBox.size * scale);
        });

        // only run draw function once
        noLoop();
      }

      // mousePressed should catch all touchStarted events as well
      // docs: https://p5js.org/reference/#/p5/touchStarted
      function mousePressed() {
        // create a random new box based on mouse position
        const box = {
          color: Math.random() * 255,
          size: 1 + Math.random() * 2,
          x: (mouseX / windowWidth) * 100,
          y: (mouseY / windowHeight) * 100,
        };

        // create a new box at the location of the mouse
        if (!loading) {
          olta.create("boxes", box);

          // add the box to the pendingBoxes array so we can render it in the p5 draw function
          pendingBoxes.push(box);

          loading = true;
          timeLeft = timerSeconds;

          // trigger p5 draw function
          loop();
        }
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        // trigger p5 draw function on resize
        loop();
      }

      // utils
      function percentageOf(value, percent) {
        return value * (percent * 0.01);
      }
    </script>
  </body>
</html>
