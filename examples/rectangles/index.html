<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Example p5 Project</title>
  </head>
  <body>
    <div id="loadingOverlay">
      <div id="loadingDiv">
        <svg viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" fill="none" stroke="#FFFFFF50" stroke-width="10" />
          <circle id="progress" cx="50" cy="50" r="45" fill="none" stroke="white" stroke-width="11" stroke-dasharray="0 283" stroke-linecap="round" />
        </svg>
      </div>
      <div id="popupMessage">
        <span id="loadingText"></span>
      </div>
    </div>

    <button id="playPauseButton">
      <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
        <path d="M8 5v14l11-7z" fill="white"/>
      </svg>
      <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" style="display:none;">
        <path d="M6 19h4V5H6zm8-14v14h4V5z" fill="white"/>
      </svg>      
    </button>
    <button id="stopButton">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
        <path d="M6 6h12v12H6z" fill="white"/>
      </svg>      
    </button>

    <script src="../../lib/p5.min.js"></script>
    <script src="../../lib/olta.js"></script>
    <script>
      const olta = Olta();
      const timerSeconds = 1000; // Time between creating new interactions, in milliseconds (1000 = 10 seconds)
      const progress = document.getElementById("progress");
      const loadingText = document.getElementById("loadingText");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const playPauseButton = document.getElementById("playPauseButton");
      const stopButton = document.getElementById("stopButton");
      const playIcon = document.getElementById("playIcon");
      const pauseIcon = document.getElementById("pauseIcon");

      let initialStateItems = [];
      let itemsToShow = [];
      let showQueue = [];
      let timeout;
      let runningPlayback = false;
      let walletAddress, fullWalletAddress, currentMessage;
      let loading = false;
      let timeLeft = timerSeconds;

      const defaultMessage = "Thanks for collaborating! Please make sure you are logged in";

      let messages = [
        "${walletAddress} Thank you for your contribution!",
        "Hi ${walletAddress}! You left your mark! 👍",
        "You're way cooler than people think 😎 ${walletAddress}",
        "Thanks for participating ${walletAddress}! 🔥",
        "Hi ${walletAddress}! Thanks for collaborating :)",
      ];

      let boxes = [];
      let pendingBoxes = [];
      const scale = 20;

      function setup() {
        createCanvas(displayWidth, displayHeight);
        background(0);
        noStroke();
        rectMode(CENTER);

        olta.onUpdate(() => {
          boxes = olta.getAll("boxes");
          initialStateItems = boxes?.filter(item => typeof item?._id === "number");
          itemsToShow = boxes?.slice(initialStateItems?.length);
          fullWalletAddress = olta.getActiveWalletAddress();
          if (!boxes || boxes.length < 1) {
            return;
          }
          pendingBoxes = [];
          loop();
        });
      }

      function draw() {
        background(0);
        noStroke();
        if (loading) {
          loadingOverlay.style.display = "block";
          var timer = setInterval(() => {
            timeLeft -= 1;
            const dashOffset = ((timerSeconds - timeLeft) / timerSeconds) * 283;
            progress.style.strokeDasharray = `${dashOffset} 360`;
            if (timeLeft <= 0) {
              loading = false;
              clearInterval(timer);
              loadingOverlay.style.display = "none";
              return;
            }
          }, 10);
        } else {
          timeLeft = timerSeconds;
          loadingOverlay.style.display = "none";
        }

        if (!boxes || boxes.length < 1) {
          return;
        }

        boxes?.forEach((box) => {
          const x = percentageOf(windowWidth, box.x);
          const y = percentageOf(windowHeight, box.y);
          fill(box.color);
          rect(x, y, box.size * scale, box.size * scale);
        });

        pendingBoxes?.forEach((pendingBox) => {
          const x = percentageOf(windowWidth, pendingBox.x);
          const y = percentageOf(windowHeight, pendingBox.y);
          stroke(255, 0, 0);
          rect(x, y, pendingBox.size * scale, pendingBox.size * scale);
        });

        noLoop();
      }

      function mousePressed(e) {
        if (e.target.closest("#playPauseButton")) {
          togglePlayback();
        } else if (e.target.closest("#stopButton")) { 
          stopPlayback();
        } else {
          clearTimeout(timeout);
          if (runningPlayback === true) {
            clear();
            background(0);
            pendingBoxes = [];
            const list = olta.getAll("boxes");
            list.forEach((item) => {
              const x = percentageOf(windowWidth, item.x);
              const y = percentageOf(windowHeight, item.y);
              fill(item.color);
              rect(x, y, item.size * scale, item.size * scale);
            });
            runningPlayback = false;
          } else {
            const box = {
              color: Math.random() * 255,
              size: 1 + Math.random() * 2,
              x: (mouseX / windowWidth) * 100,
              y: (mouseY / windowHeight) * 100,
            };
            if (!loading) {
              olta.create("boxes", box);
              pendingBoxes.push(box);
              loading = true;
              timeLeft = timerSeconds;
              generateRandomMessage().then((message) => {
                currentMessage = message;
                loadingText.innerHTML = currentMessage;
              });
              loop();
            }
          }
        }
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        loop();
      }

      function percentageOf(value, percent) {
        return value * (percent * 0.01);
      }

      async function generateRandomMessage() {
        let fullWalletAddress = await olta.getActiveWalletAddress();
        if (fullWalletAddress) {
          let walletAddress =
            fullWalletAddress.slice(0, 4) + "..." + fullWalletAddress.slice(-4);
          let randomIndex = Math.floor(Math.random() * messages.length);
          let finalMessage = messages[randomIndex].replace(
            "${walletAddress}",
            `<strong>${walletAddress}</strong>`
          );
          return finalMessage;
        } else {
          return defaultMessage;
        }
      }

      function togglePlayback() {
        if (runningPlayback) {
          pausePlayback();
        } else {
          startPlayback();
        }
      }

      function startPlayback() {
        runningPlayback = true;
        playIcon.style.display = "none";
        pauseIcon.style.display = "block";
        clear();
        background(0);
        initialStateItems?.map((box) => {
          const x = percentageOf(windowWidth, box.x);
          const y = percentageOf(windowHeight, box.y);
          fill(box.color);
          rect(x, y, box.size * scale, box.size * scale);
        });

        itemsToShow?.map((item, index) => {
          setTimeout(() => {
            if (!runningPlayback) return;
            const x = percentageOf(windowWidth, item.x);
            const y = percentageOf(windowHeight, item.y);
            fill(item.color);
            rect(x, y, item.size * scale, item.size * scale);
            if (index === itemsToShow.length - 1) {
              runningPlayback = false;
              playIcon.style.display = "block";
              pauseIcon.style.display = "none";
            }
          }, index * 2000);
        });
      }

      function pausePlayback() {
        runningPlayback = false;
        playIcon.style.display = "block";
        pauseIcon.style.display = "none";
      }

      function stopPlayback() {
        runningPlayback = false;
        playIcon.style.display = "block";
        pauseIcon.style.display = "none";
        clear();
        background(0);
        boxes.forEach((box) => {
          const x = percentageOf(windowWidth, box.x);
          const y = percentageOf(windowHeight, box.y);
          fill(box.color);
          rect(x, y, box.size * scale, box.size * scale);
        });
      }
    </script>
  </body>
</html>
